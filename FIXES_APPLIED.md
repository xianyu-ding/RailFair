# ğŸ”§ ä¿®å¤è¯´æ˜

## å·²ä¿®å¤çš„é—®é¢˜

### 1. âœ… ç¥¨ä»·æ›´æ–°é—´éš”ä¿®å¤
**é—®é¢˜**: ç³»ç»Ÿåœ¨1å¤©åå°±é‡æ–°ä¸‹è½½ç¥¨ä»·æ•°æ®  
**ä¿®å¤**: å°†æ›´æ–°é—´éš”ä»1å¤©æ”¹ä¸º30å¤©

**ä¿®æ”¹æ–‡ä»¶**:
- `price_fetcher.py`
  - `_should_update_fares_data()` å‡½æ•°çš„é»˜è®¤å‚æ•°ä» `max_age_days=1` æ”¹ä¸º `max_age_days=30`
  - `initialize_fares_system()` å‡½æ•°ä¸­çš„è°ƒç”¨ä» `max_age_days=1` æ”¹ä¸º `max_age_days=30`
  - æ—¥å¿—ä¿¡æ¯ä»"æ•°æ®æœªè¶…è¿‡1å¤©"æ”¹ä¸º"æ•°æ®æœªè¶…è¿‡30å¤©"

**è¯´æ˜**: 
- NRDPç¥¨ä»·æ•°æ®æ¯å‘¨æ›´æ–°ä¸€æ¬¡
- æˆ‘ä»¬æ¯æœˆï¼ˆ30å¤©ï¼‰æ£€æŸ¥ä¸€æ¬¡æ›´æ–°ï¼Œé¿å…é¢‘ç¹ä¸‹è½½
- å¦‚æœZIPæ–‡ä»¶å­˜åœ¨ä¸”æœªè¶…è¿‡30å¤©ï¼Œä½¿ç”¨ç°æœ‰ç¼“å­˜

### 2. âœ… æ•°æ®åº“è¡¨æŸ¥è¯¢ä¿®å¤
**é—®é¢˜**: ä»£ç å°è¯•è®¿é—®ä¸å­˜åœ¨çš„ `hsp_records` è¡¨ï¼Œå¯¼è‡´é”™è¯¯  
**ä¿®å¤**: å°†æ‰€æœ‰æŸ¥è¯¢æ”¹ä¸ºä½¿ç”¨å®é™…å­˜åœ¨çš„è¡¨

**ä¿®æ”¹æ–‡ä»¶**:
- `api/db_pool.py`

**ä¿®å¤å†…å®¹**:

#### a) ç´¢å¼•åˆ›å»ºä¿®å¤
- **ç§»é™¤**: ä¸å­˜åœ¨çš„ `hsp_records` è¡¨ç´¢å¼•
- **æ·»åŠ **: å®é™…å­˜åœ¨çš„è¡¨ç´¢å¼•ï¼š
  - `hsp_service_metrics` è¡¨ç´¢å¼•
  - `hsp_service_details` è¡¨ç´¢å¼•
  - `fare_cache` è¡¨ç´¢å¼•ï¼ˆä¸æ˜¯ `fares` è¡¨ï¼‰
  - `route_statistics` è¡¨ç´¢å¼•

#### b) `get_popular_routes()` å‡½æ•°ä¿®å¤
- **ä¹‹å‰**: ä» `hsp_records` è¡¨æŸ¥è¯¢
- **ç°åœ¨**: ä» `route_statistics` è¡¨æŸ¥è¯¢
- ä½¿ç”¨ `total_services` ä½œä¸ºæŸ¥è¯¢è®¡æ•°
- ä½¿ç”¨ `on_time_percentage` ä½œä¸ºå‡†ç‚¹ç‡

#### c) `get_prediction_data()` å‡½æ•°ä¿®å¤
- **ä¹‹å‰**: ä» `hsp_records` è¡¨æŸ¥è¯¢
- **ç°åœ¨**: ä» `route_statistics` è¡¨æŸ¥è¯¢ï¼ˆä½¿ç”¨é¢„è®¡ç®—çš„ç»Ÿè®¡æ•°æ®ï¼‰

#### d) `get_route_statistics()` å‡½æ•°ä¿®å¤
- **ä¹‹å‰**: ä» `hsp_records` è¡¨æŸ¥è¯¢
- **ç°åœ¨**: ä» `route_statistics` è¡¨æŸ¥è¯¢
- åŒ¹é…å®é™…çš„è¡¨åˆ—åï¼š
  - `time_to_5_percentage` (ä¸æ˜¯ `delay_5_percentage`)
  - `time_to_10_percentage` (ä¸æ˜¯ `delay_10_percentage`)
  - `time_to_30_percentage` (ä¸æ˜¯ `delay_30_percentage`)
  - `median_delay_minutes` (ä¸æ˜¯ `min_delay_minutes`)

## ğŸ“Š æ•°æ®åº“è¡¨ç»“æ„è¯´æ˜

### å®é™…å­˜åœ¨çš„è¡¨ï¼š
- âœ… `hsp_service_metrics` - HSPæœåŠ¡æŒ‡æ ‡
- âœ… `hsp_service_details` - HSPæœåŠ¡è¯¦æƒ…
- âœ… `route_statistics` - è·¯çº¿ç»Ÿè®¡ï¼ˆé¢„è®¡ç®—ï¼‰
- âœ… `fare_cache` - ç¥¨ä»·ç¼“å­˜
- âœ… `toc_statistics` - è¿è¥å•†ç»Ÿè®¡
- âœ… `time_slot_statistics` - æ—¶æ®µç»Ÿè®¡

### ä¸å­˜åœ¨çš„è¡¨ï¼ˆå·²ç§»é™¤å¼•ç”¨ï¼‰ï¼š
- âŒ `hsp_records` - ä¸å­˜åœ¨ï¼Œå·²æ”¹ä¸ºä½¿ç”¨ `route_statistics`

## ğŸš€ æµ‹è¯•å»ºè®®

1. **é‡å¯APIæœåŠ¡å™¨**:
   ```bash
   # åœæ­¢å½“å‰è¿è¡Œçš„æœåŠ¡å™¨ (Ctrl+C)
   # ç„¶åé‡æ–°å¯åŠ¨
   python3 -m api.app
   ```

2. **éªŒè¯ä¿®å¤**:
   - æ£€æŸ¥å¯åŠ¨æ—¥å¿—ï¼Œåº”è¯¥ä¸å†æœ‰ `hsp_records` ç›¸å…³é”™è¯¯
   - æ£€æŸ¥ç¥¨ä»·æ›´æ–°æ—¥å¿—ï¼Œåº”è¯¥æ˜¾ç¤º"æ•°æ®æœªè¶…è¿‡30å¤©"
   - æµ‹è¯•APIæŸ¥è¯¢ï¼Œåº”è¯¥èƒ½æ­£å¸¸è¿”å›ç»“æœ

3. **æµ‹è¯•æŸ¥è¯¢**:
   ```bash
   # æµ‹è¯•å¥åº·æ£€æŸ¥
   curl http://localhost:8000/health
   
   # æµ‹è¯•é¢„æµ‹API
   curl -X POST http://localhost:8000/api/predict \
     -H "Content-Type: application/json" \
     -d '{
       "origin": "EUS",
       "destination": "MAN",
       "departure_date": "2025-12-25",
       "departure_time": "09:30",
       "include_fares": true
     }'
   ```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ç«¯å£å ç”¨**: å¦‚æœçœ‹åˆ° "address already in use" é”™è¯¯ï¼Œè¯´æ˜ä¹‹å‰çš„æœåŠ¡å™¨è¿˜åœ¨è¿è¡Œ
   - ä½¿ç”¨ `lsof -i :8000` æŸ¥æ‰¾å ç”¨ç«¯å£çš„è¿›ç¨‹
   - ä½¿ç”¨ `kill -9 <PID>` ç»ˆæ­¢è¿›ç¨‹
   - æˆ–ä½¿ç”¨å…¶ä»–ç«¯å£: `PORT=8080 python3 -m api.app`

2. **Redisè­¦å‘Š**: å¦‚æœæ²¡æœ‰Redisï¼Œç³»ç»Ÿä¼šä½¿ç”¨å†…å­˜ç¼“å­˜ï¼ŒåŠŸèƒ½æ­£å¸¸ï¼Œåªæ˜¯ç¼“å­˜ä¸ä¼šæŒä¹…åŒ–

3. **æ•°æ®åº“è¿æ¥**: ç¡®ä¿ `data/railfair.db` æ–‡ä»¶å­˜åœ¨ä¸”æœ‰æ­£ç¡®çš„è¡¨ç»“æ„

## ğŸ“ åç»­ä¼˜åŒ–å»ºè®®

1. è€ƒè™‘æ·»åŠ æ•°æ®åº“è¿ç§»è„šæœ¬ï¼Œè‡ªåŠ¨åˆ›å»ºç¼ºå¤±çš„è¡¨
2. æ·»åŠ æ›´è¯¦ç»†çš„é”™è¯¯å¤„ç†ï¼Œå½“è¡¨ä¸å­˜åœ¨æ—¶ç»™å‡ºæ›´å‹å¥½çš„æç¤º
3. è€ƒè™‘æ·»åŠ æ•°æ®åº“å¥åº·æ£€æŸ¥ï¼Œåœ¨å¯åŠ¨æ—¶éªŒè¯è¡¨ç»“æ„

