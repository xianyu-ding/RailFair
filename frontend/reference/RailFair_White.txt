import React, { useState, useEffect, useRef } from 'react';
import { 
  Train, 
  Calendar, 
  MapPin, 
  Search, 
  ArrowRight, 
  ChevronRight, 
  AlertCircle,
  CheckCircle2,
  Sparkles,
  Bot,
  Loader2
} from 'lucide-react';

// --- Configuration ---
const apiKey = ""; // injected by environment

// --- Mock Data Constants ---

const UK_STATIONS = [
  "London Kings Cross (KGX)", "London Euston (EUS)", "London Paddington (PAD)", 
  "Manchester Piccadilly (MAN)", "Birmingham New Street (BHM)", "Edinburgh Waverley (EDB)",
  "Glasgow Central (GLC)", "Leeds (LDS)", "Bristol Temple Meads (BRI)",
  "Liverpool Lime Street (LIV)", "Newcastle (NCL)", "York (YRK)",
  "Cardiff Central (CDF)", "Nottingham (NOT)", "Sheffield (SHF)"
];

// CLEANER DATA SNIPPETS: Less "noise", more structured
const RAIN_DATA_SNIPPETS = [
  "ON_TIME", "LNER_800", "£67.50", 
  "KGX→MAN", "DLY_03M", "PLAT_05", 
  "98%", "SYNC_OK", "KGX", 
  "GWR", "£122.30", "CANCEL", 
  "AVANTI", "101101", "SPEED_OK"
];

// --- Helper Components ---

const ProbabilityRing = ({ percentage, color = "#16a34a" }) => {
  const radius = 24;
  const circumference = 2 * Math.PI * radius;
  const strokeDashoffset = circumference - (percentage / 100) * circumference;

  return (
    <div className="relative flex items-center justify-center w-16 h-16">
      <svg className="transform -rotate-90 w-16 h-16">
        <circle
          className="text-slate-100"
          strokeWidth="3"
          stroke="currentColor"
          fill="transparent"
          r={radius}
          cx="32"
          cy="32"
        />
        <circle
          style={{ stroke: color, transition: 'stroke-dashoffset 1s ease-in-out' }}
          strokeWidth="3"
          strokeDasharray={circumference}
          strokeDashoffset={strokeDashoffset}
          strokeLinecap="round"
          fill="transparent"
          r={radius}
          cx="32"
          cy="32"
        />
      </svg>
      <span className="absolute text-xs font-semibold text-slate-700">{percentage}%</span>
    </div>
  );
};

// --- Main Application Component ---

export default function App() {
  // State
  const [searchState, setSearchState] = useState('idle'); // idle, loading, results
  const [fromStation, setFromStation] = useState('');
  const [toStation, setToStation] = useState('');
  const [date, setDate] = useState('');
  const [results, setResults] = useState([]);
  
  // Gemini Integration State
  const [tripBrief, setTripBrief] = useState(null);
  const [isGeneratingBrief, setIsGeneratingBrief] = useState(false);
  const [analyzingCardId, setAnalyzingCardId] = useState(null);
  const [cardAnalyses, setCardAnalyses] = useState({}); 

  // Autocomplete State
  const [fromSuggestions, setFromSuggestions] = useState([]);
  const [toSuggestions, setToSuggestions] = useState([]);
  const [activeField, setActiveField] = useState(null);

  // Canvas Ref for Rain
  const canvasRef = useRef(null);

  // --- Data Rain Animation Logic (Clean & Minimal) ---
  useEffect(() => {
    const canvas = canvasRef.current;
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    let animationFrameId;
    let particles = [];

    const resizeCanvas = () => {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight * 0.55; 
    };

    class Particle {
      constructor() {
        this.reset();
        this.y = Math.random() * canvas.height; 
      }

      reset() {
        this.x = Math.random() * canvas.width;
        this.y = -50;
        this.speed = 0.6 + Math.random() * 1.2; // Slightly faster
        this.text = RAIN_DATA_SNIPPETS[Math.floor(Math.random() * RAIN_DATA_SNIPPETS.length)];
        
        // VISIBILITY UPGRADE: Increased opacity range
        this.opacity = 0.12 + Math.random() * 0.28; 
        
        // VISIBILITY UPGRADE: Larger font size
        this.size = 13; 
        
        // VISIBILITY UPGRADE: Darker colors for white background
        if (this.text.includes("OK") || this.text.includes("%")) {
            this.color = "rgba(37, 99, 235,"; // Blue-600 (Darker than Blue-500)
        } else {
            this.color = "rgba(100, 116, 139,"; // Slate-500 (Darker than Slate-400)
        }
      }

      update() {
        this.y += this.speed;
        if (this.y > canvas.height + 50) {
          this.reset();
        }
      }

      draw() {
        // Using medium weight font for better legibility
        ctx.font = `500 ${this.size}px 'Inter', sans-serif`; 
        ctx.fillStyle = `${this.color} ${this.opacity})`;
        ctx.fillText(this.text, this.x, this.y);
      }
    }

    const initParticles = () => {
      particles = Array.from({ length: 35 }, () => new Particle()); // Slightly increased count
    };

    const animate = () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      particles.forEach(p => {
        p.update();
        p.draw();
      });
      animationFrameId = requestAnimationFrame(animate);
    };

    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();
    initParticles();
    animate();

    return () => {
      window.removeEventListener('resize', resizeCanvas);
      cancelAnimationFrame(animationFrameId);
    };
  }, []);

  // --- Gemini API Functions ---

  const callGemini = async (prompt) => {
    try {
      const response = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }]
          })
        }
      );
      
      if (!response.ok) throw new Error('API Call failed');
      const data = await response.json();
      return data.candidates?.[0]?.content?.parts?.[0]?.text || "Analysis currently unavailable.";
    } catch (error) {
      console.error("Gemini Error:", error);
      return "Unable to connect to AI services. Please try again later.";
    }
  };

  const generateTripBrief = async () => {
    setIsGeneratingBrief(true);
    const optionsContext = results.map(r => 
      `Option ${r.id}: ${r.operator} departing ${r.departure}, £${r.price.advance}, ${r.probability}% on-time probability.`
    ).join('\n');
    const prompt = `You are an expert UK rail travel consultant. Analyze these journey options from ${fromStation} to ${toStation}:
    ${optionsContext}
    Provide a "Smart Trip Brief". Identify the best "Value Pick" and "Fastest/Reliable" option. Keep it under 50 words. Use formatting like *bold* for emphasis.`;
    const text = await callGemini(prompt);
    setTripBrief(text);
    setIsGeneratingBrief(false);
  };

  const analyzeRisk = async (train) => {
    if (cardAnalyses[train.id]) return; 
    setAnalyzingCardId(train.id);
    const prompt = `Analyze delay risk for train: ${train.operator} from ${fromStation} to ${toStation} at ${train.departure}. On-Time Prob: ${train.probability}%. Status: ${train.status}. 
    Explain why based on typical UK rail factors. Keep it to 2 sentences. Be technical but accessible.`;
    const text = await callGemini(prompt);
    setCardAnalyses(prev => ({ ...prev, [train.id]: text }));
    setAnalyzingCardId(null);
  };

  // --- Handlers ---

  const handleStationInput = (value, type) => {
    if (type === 'from') {
      setFromStation(value);
      setFromSuggestions(value.length > 0 ? UK_STATIONS.filter(s => s.toLowerCase().includes(value.toLowerCase())) : []);
    } else {
      setToStation(value);
      setToSuggestions(value.length > 0 ? UK_STATIONS.filter(s => s.toLowerCase().includes(value.toLowerCase())) : []);
    }
  };

  const selectStation = (station, type) => {
    if (type === 'from') {
      setFromStation(station);
      setFromSuggestions([]);
    } else {
      setToStation(station);
      setToSuggestions([]);
    }
    setActiveField(null);
  };

  const handleSearch = async (e) => {
    e.preventDefault();
    if (!fromStation || !toStation || !date) return;
    setSearchState('loading');
    setTripBrief(null);
    setCardAnalyses({});

    setTimeout(() => {
      const mockResults = Array.from({ length: 4 }).map((_, i) => {
        const baseHour = 8 + i;
        const isDelayed = Math.random() > 0.7;
        const probability = isDelayed ? Math.floor(Math.random() * 30) + 40 : Math.floor(Math.random() * 15) + 85;
        return {
          id: i,
          operator: i % 2 === 0 ? "LNER" : "Avanti West Coast",
          departure: `${baseHour}:15`,
          arrival: `${baseHour + 2}:42`,
          duration: "2h 27m",
          changes: 0,
          platform: Math.floor(Math.random() * 10) + 1,
          status: isDelayed ? `Delayed ${Math.floor(Math.random() * 15)}m` : "On Time",
          probability: probability,
          price: {
            advance: (45.50 + Math.random() * 20).toFixed(2),
            anytime: (120.00 + Math.random() * 30).toFixed(2)
          }
        };
      });
      setResults(mockResults);
      setSearchState('results');
    }, 1500);
  };

  return (
    <div className="min-h-screen bg-white text-slate-900 font-sans selection:bg-blue-100 overflow-x-hidden relative">
      
      {/* --- Background Accents (Ultra Minimal) --- */}
      <div className="fixed top-0 left-0 w-full h-full overflow-hidden z-0 pointer-events-none">
         {/* Very subtle top gradient */}
         <div className="absolute top-0 w-full h-64 bg-gradient-to-b from-slate-50 to-transparent" />
      </div>

      {/* --- Data Rain Canvas --- */}
      <div className="absolute top-0 left-0 w-full h-[55vh] z-0 pointer-events-none mask-gradient-to-b-light">
        <canvas ref={canvasRef} className="w-full h-full" />
        <div className="absolute bottom-0 left-0 w-full h-32 bg-gradient-to-b from-transparent to-white" />
      </div>

      {/* --- Main Content --- */}
      <div className="relative z-10 container mx-auto px-4 min-h-screen flex flex-col max-w-5xl">
        
        {/* Header */}
        <header className="flex justify-between items-center py-8">
          <div className="flex items-center gap-2.5">
            <div className="w-9 h-9 bg-blue-600 text-white rounded-lg flex items-center justify-center shadow-sm">
              <Train className="w-5 h-5" />
            </div>
            <span className="text-xl font-bold tracking-tight text-slate-900">
              RailFair
            </span>
          </div>
          <nav className="hidden md:flex gap-8 text-sm font-medium text-slate-500">
            <a href="#" className="hover:text-blue-600 transition-colors">Map</a>
            <a href="#" className="hover:text-blue-600 transition-colors">Analysis</a>
            <a href="#" className="hover:text-blue-600 transition-colors">API</a>
          </nav>
          <div className="w-8 md:hidden" />
        </header>

        {/* Hero & Search Section */}
        <main className={`flex-1 flex flex-col items-center transition-all duration-700 ${searchState === 'results' ? 'justify-start pt-4' : 'justify-center pb-24'}`}>
          
          {/* Hero Text */}
          <div className={`text-center mb-10 transition-all duration-500 z-20 ${searchState === 'results' ? 'opacity-0 h-0 overflow-hidden mb-0' : 'opacity-100'}`}>
            <h1 className="text-4xl md:text-6xl font-bold tracking-tight mb-4 text-slate-900">
              Predict delays. <br />
              <span className="text-blue-600">
                Save on fares.
              </span>
            </h1>
            <p className="text-slate-500 max-w-md mx-auto text-lg">
              Intelligent rail forecasting. No clutter.
            </p>
          </div>

          {/* Search Card - Clean Minimalist */}
          <div className={`w-full max-w-4xl transition-all duration-700 ease-out ${searchState === 'results' ? 'transform -translate-y-0' : ''}`}>
            <form onSubmit={handleSearch} className="relative">
              
              {/* Clean Container */}
              <div className="relative bg-white border border-slate-200 rounded-xl p-3 shadow-xl shadow-slate-200/60 grid grid-cols-1 md:grid-cols-12 gap-3 items-center">
                
                {/* From Input */}
                <div className="md:col-span-4 relative z-20">
                  <div className="flex items-center px-4 h-14 bg-white rounded-lg border border-slate-200 focus-within:border-blue-500 focus-within:ring-2 focus-within:ring-blue-500/10 transition-all">
                    <MapPin className="w-5 h-5 text-slate-400 shrink-0" />
                    <input
                      type="text"
                      value={fromStation}
                      onChange={(e) => handleStationInput(e.target.value, 'from')}
                      onFocus={() => setActiveField('from')}
                      placeholder="From"
                      className="w-full bg-transparent border-none focus:ring-0 text-slate-900 placeholder-slate-400 ml-2 font-medium truncate"
                    />
                  </div>
                  {activeField === 'from' && fromSuggestions.length > 0 && (
                    <div className="absolute top-full left-0 w-full mt-2 bg-white border border-slate-100 rounded-lg shadow-lg overflow-hidden max-h-60 overflow-y-auto z-50">
                      {fromSuggestions.map((s, i) => (
                        <div key={i} onClick={() => selectStation(s, 'from')} className="px-4 py-3 hover:bg-slate-50 cursor-pointer text-sm text-slate-700 border-b border-slate-50 last:border-0">
                          {s}
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                {/* Arrow Icon */}
                <div className="hidden md:flex md:col-span-1 justify-center text-slate-300">
                  <ArrowRight className="w-5 h-5" />
                </div>

                {/* To Input */}
                <div className="md:col-span-4 relative z-20">
                  <div className="flex items-center px-4 h-14 bg-white rounded-lg border border-slate-200 focus-within:border-blue-500 focus-within:ring-2 focus-within:ring-blue-500/10 transition-all">
                    <MapPin className="w-5 h-5 text-slate-400 shrink-0" />
                    <input
                      type="text"
                      value={toStation}
                      onChange={(e) => handleStationInput(e.target.value, 'to')}
                      onFocus={() => setActiveField('to')}
                      placeholder="To"
                      className="w-full bg-transparent border-none focus:ring-0 text-slate-900 placeholder-slate-400 ml-2 font-medium truncate"
                    />
                  </div>
                  {activeField === 'to' && toSuggestions.length > 0 && (
                    <div className="absolute top-full left-0 w-full mt-2 bg-white border border-slate-100 rounded-lg shadow-lg overflow-hidden max-h-60 overflow-y-auto z-50">
                      {toSuggestions.map((s, i) => (
                        <div key={i} onClick={() => selectStation(s, 'to')} className="px-4 py-3 hover:bg-slate-50 cursor-pointer text-sm text-slate-700 border-b border-slate-50 last:border-0">
                          {s}
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                {/* Date Picker */}
                <div className="md:col-span-2">
                  <div className="flex items-center px-4 h-14 bg-white rounded-lg border border-slate-200 focus-within:border-blue-500 focus-within:ring-2 focus-within:ring-blue-500/10 transition-all relative overflow-hidden">
                    <Calendar className="w-5 h-5 text-slate-400 shrink-0 pointer-events-none" />
                    <input
                      type="date"
                      value={date}
                      onChange={(e) => setDate(e.target.value)}
                      className="w-full bg-transparent border-none focus:ring-0 text-slate-900 placeholder-slate-400 ml-1"
                    />
                  </div>
                </div>

                {/* Search Button */}
                <div className="md:col-span-1 h-14">
                  <button 
                    type="submit"
                    disabled={searchState === 'loading'}
                    className="w-full h-full bg-blue-600 hover:bg-blue-700 text-white rounded-lg flex items-center justify-center transition-all shadow-lg shadow-blue-600/20 disabled:opacity-70"
                  >
                    {searchState === 'loading' ? (
                      <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin" />
                    ) : (
                      <Search className="w-5 h-5" />
                    )}
                  </button>
                </div>

              </div>
            </form>
          </div>

          {/* Results Section */}
          {searchState === 'results' && (
            <div className="w-full max-w-4xl mt-10 animate-in slide-in-from-bottom-10 fade-in duration-700 pb-20">
              
              {/* Results Header & Smart Brief */}
              <div className="flex flex-col gap-4 mb-6">
                <div className="flex justify-between items-end px-1">
                  <div>
                    <h2 className="text-xl font-bold text-slate-900">
                      {fromStation.split('(')[0]} <span className="text-slate-400 px-2">→</span> {toStation.split('(')[0]}
                    </h2>
                    <p className="text-sm text-slate-500 mt-1">
                      {new Date(date).toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long' })}
                    </p>
                  </div>
                  
                  {/* Gemini Trip Brief Button */}
                  {!tripBrief && !isGeneratingBrief && (
                    <button 
                      onClick={generateTripBrief}
                      className="flex items-center gap-2 text-xs font-semibold text-blue-600 bg-blue-50 hover:bg-blue-100 px-4 py-2 rounded-full transition-colors border border-blue-100"
                    >
                      <Sparkles className="w-3 h-3" />
                      Smart Brief
                    </button>
                  )}
                  {isGeneratingBrief && (
                    <div className="flex items-center gap-2 text-xs font-medium bg-slate-100 text-slate-500 px-4 py-2 rounded-full">
                      <Bot className="w-3 h-3 animate-pulse" />
                      Thinking...
                    </div>
                  )}
                </div>

                {/* Smart Brief Display */}
                {tripBrief && (
                  <div className="p-5 bg-gradient-to-br from-blue-50 to-white border border-blue-100 rounded-xl animate-in fade-in duration-500">
                    <div className="flex items-start gap-3">
                      <div className="bg-blue-100 p-1.5 rounded-md shrink-0 mt-0.5">
                         <Sparkles className="w-4 h-4 text-blue-600" />
                      </div>
                      <div>
                        <h3 className="text-xs font-bold text-blue-700 uppercase mb-1 tracking-wide">Smart Analysis</h3>
                        <p className="text-sm text-slate-700 leading-relaxed whitespace-pre-wrap">{tripBrief}</p>
                      </div>
                    </div>
                  </div>
                )}
              </div>

              {/* Cards Grid */}
              <div className="flex flex-col gap-4">
                {results.map((train, idx) => (
                  <div 
                    key={train.id}
                    className="bg-white border border-slate-200 rounded-xl p-5 transition-all hover:border-blue-400 hover:shadow-md group"
                    style={{ animationDelay: `${idx * 100}ms` }}
                  >
                    <div className="grid grid-cols-1 md:grid-cols-12 gap-6 items-center">
                      
                      {/* Times & Operator */}
                      <div className="md:col-span-4">
                        <div className="flex items-center gap-3 mb-1.5">
                          <span className="text-2xl font-bold text-slate-900">{train.departure}</span>
                          <ArrowRight className="w-4 h-4 text-slate-300" />
                          <span className="text-2xl font-bold text-slate-400">{train.arrival}</span>
                        </div>
                        <div className="flex items-center gap-2 text-sm text-slate-500 font-medium">
                          <span className="text-slate-700">{train.operator}</span>
                          <span className="text-slate-300">•</span>
                          <span>{train.duration}</span>
                          <span className="text-slate-300">•</span>
                          <span>{train.changes === 0 ? 'Direct' : `${train.changes} Chg`}</span>
                        </div>
                      </div>

                      {/* Probability Gauge */}
                      <div className="md:col-span-3 flex items-center gap-4 border-l-0 md:border-l border-slate-100 md:pl-6">
                        <ProbabilityRing 
                          percentage={train.probability} 
                          color={train.probability > 80 ? '#16a34a' : train.probability > 60 ? '#ca8a04' : '#dc2626'} 
                        />
                        <div className="flex flex-col">
                          <span className="text-[10px] text-slate-400 uppercase tracking-wider font-bold mb-0.5">Reliability</span>
                          <div className="flex items-center gap-1 mb-1">
                            <span className={`text-sm font-bold ${train.probability > 80 ? 'text-green-600' : train.probability > 60 ? 'text-yellow-600' : 'text-red-600'}`}>
                              {train.probability > 85 ? 'High' : 'Variable'}
                            </span>
                          </div>
                          {/* Analyze Risk Button */}
                          <button 
                            onClick={() => analyzeRisk(train)}
                            disabled={!!cardAnalyses[train.id] || analyzingCardId === train.id}
                            className="text-xs flex items-center gap-1.5 text-blue-600 hover:text-blue-800 transition-colors disabled:opacity-50 disabled:cursor-default font-medium"
                          >
                             {analyzingCardId === train.id ? (
                               <><Loader2 className="w-3 h-3 animate-spin" /> Checking...</>
                             ) : cardAnalyses[train.id] ? (
                               <><CheckCircle2 className="w-3 h-3" /> Ready</>
                             ) : (
                               <>Explain Risk</>
                             )}
                          </button>
                        </div>
                      </div>

                      {/* Fares */}
                      <div className="md:col-span-5 flex items-center justify-between md:justify-end gap-6">
                         <div className="flex flex-col items-end group/price cursor-pointer">
                            <span className="text-[10px] uppercase tracking-wider font-bold text-slate-400 mb-1">Advance</span>
                            <div className="flex items-center gap-2">
                              <span className="text-xl font-bold text-slate-900 group-hover/price:text-blue-600 transition-colors">£{train.price.advance}</span>
                              <ChevronRight className="w-4 h-4 text-slate-300 group-hover/price:translate-x-1 transition-transform" />
                            </div>
                         </div>
                         <div className="flex flex-col items-end opacity-50 hover:opacity-100 transition-opacity">
                            <span className="text-[10px] uppercase tracking-wider font-bold text-slate-400 mb-1">Anytime</span>
                            <span className="text-sm font-medium text-slate-500 line-through decoration-slate-300">£{train.price.anytime}</span>
                         </div>
                      </div>
                    </div>

                    {/* Gemini Analysis Result (Dropdown) */}
                    {cardAnalyses[train.id] && (
                      <div className="mt-4 pt-4 border-t border-slate-100 animate-in slide-in-from-top-2">
                        <div className="flex items-start gap-3 bg-slate-50 p-3 rounded-lg">
                          <Bot className="w-4 h-4 text-slate-500 mt-0.5 shrink-0" />
                          <div>
                            <p className="text-sm text-slate-700 leading-relaxed">{cardAnalyses[train.id]}</p>
                          </div>
                        </div>
                      </div>
                    )}

                  </div>
                ))}
              </div>
            </div>
          )}

        </main>

      </div>
      
      <style>{`
        .mask-gradient-to-b-light {
          mask-image: linear-gradient(to bottom, black 0%, black 70%, transparent 100%);
          -webkit-mask-image: linear-gradient(to bottom, black 0%, black 70%, transparent 100%);
        }
        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .animate-in {
          animation: fadeIn 0.6s ease-out forwards;
        }
      `}</style>
    </div>
  );
}