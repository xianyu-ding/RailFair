# demo.py 使用指南

`demo.py` 是一个完整的 API 功能演示脚本，用于测试和展示 RailFair API 的所有功能。

## 📋 功能演示

演示脚本会自动测试以下功能：

1. ✅ **健康检查** - 检查API服务器状态
2. 🚄 **延误预测** - 预测火车延误并比较票价
3. 💬 **反馈提交** - 提交用户反馈
4. ✅ **输入验证** - 测试各种验证错误
5. 📊 **统计信息** - 查看API使用统计
6. 📚 **API文档** - 检查文档端点
7. ⚡ **速率限制** - 测试速率限制功能（可选）

## 🚀 使用方法

### 前置要求

1. **启动API服务器**

   在运行演示之前，必须先启动API服务器：

   ```bash
   # 在第一个终端窗口
   python api/app.py
   ```

   看到以下输出表示服务器已启动：
   ```
   INFO:     Uvicorn running on http://0.0.0.0:8000
   ```

2. **运行演示脚本**

   在另一个终端窗口运行：

   ```bash
   # 从项目根目录运行
   python api/demo.py
   
   # 或作为模块运行
   python -m api.demo
   ```

## 📖 使用示例

### 基本使用

```bash
# 1. 启动服务器（终端1）
python api/app.py

# 2. 运行演示（终端2）
python api/demo.py
```

### 输出示例

演示脚本会显示类似以下内容：

```
============================================================
  🚄 RailFair API 功能演示
============================================================

API服务器: http://localhost:8000
请确保API服务器正在运行...
✅ 服务器运行正常

============================================================
  1. 健康检查
============================================================

状态码: 200
服务状态: healthy
版本: 1.1.0
运行时长: 1234.56秒

============================================================
  2. 延误预测
============================================================

请求:
{
  "origin": "EUS",
  "destination": "MAN",
  "departure_date": "2024-12-25",
  "departure_time": "09:30",
  "include_fares": true
}

📊 预测结果:
  请求ID: req_abc123def456
  
  延误预测:
    - 预测延误: 12 分钟
    - 置信度: 78.0%
    - 延误等级: MINOR
    - 准点概率: 65.0%
    - 历史数据: 156 条
  
  💰 票价对比:
    - 提前票: £25.50
    - 非高峰: £45.00
    - 随时票: £89.00
    
    最便宜: advance (£25.50)
    可节省: £63.50 (71.4%)
    数据来源: SIMULATED
  
  💡 推荐建议:
    1. [money] Save £63.50
       Book advance tickets to save 71.4% compared to anytime fares
       评分: 85/100
```

## ⚙️ 配置选项

### 修改API地址

如果API服务器运行在不同地址或端口，可以修改 `demo.py` 中的配置：

```python
# 在 demo.py 第25行
BASE_URL = "http://localhost:8000"  # 默认地址

# 改为其他地址，例如：
BASE_URL = "http://localhost:8001"  # 使用8001端口
BASE_URL = "http://192.168.1.100:8000"  # 远程服务器
```

### 跳过速率限制测试

演示脚本会询问是否测试速率限制（会发送100+请求）。你可以：
- 输入 `y` 或 `Y` 来测试速率限制
- 直接按回车跳过（默认）

## 🔍 演示内容详解

### 1. 健康检查
- 测试 `/health` 端点
- 显示服务器状态、版本、运行时长

### 2. 延误预测
- 发送预测请求（EUS → MAN）
- 显示预测结果、票价比较、推荐建议
- 返回 `request_id` 用于后续反馈

### 3. 反馈提交
- 使用预测返回的 `request_id`
- 提交实际延误、评分、评论

### 4. 输入验证测试
测试以下验证错误：
- 小写CRS代码（应该大写）
- 过去的日期
- 无效的时间格式

### 5. 统计信息
- 显示API使用统计
- 总请求数、错误数、运行时长等

### 6. API文档检查
- 检查 Swagger UI (`/docs`)
- 检查 ReDoc (`/redoc`)
- 检查 OpenAPI Schema (`/openapi.json`)

### 7. 速率限制测试（可选）
- 发送100+请求测试速率限制
- 验证限制是否正确触发

## 🐛 常见问题

### 问题1：无法连接到服务器

**错误信息**：
```
❌ 无法连接到服务器
请先启动服务器: python api/app.py 或 python -m api.app
```

**解决方案**：
1. 确保API服务器正在运行
2. 检查服务器地址和端口是否正确
3. 检查防火墙设置

### 问题2：服务器运行但连接失败

**可能原因**：
- 服务器运行在不同端口
- 服务器只监听特定IP

**解决方案**：
修改 `demo.py` 中的 `BASE_URL` 变量

### 问题3：演示中途中断

**解决方案**：
- 使用 `Ctrl+C` 可以安全中断
- 演示脚本会捕获中断并显示友好消息

## 💡 使用技巧

1. **查看详细输出**
   - 演示脚本会显示所有请求和响应
   - 可以学习如何正确调用API

2. **学习API用法**
   - 查看演示脚本的代码
   - 了解如何构造请求和处理响应

3. **测试自定义场景**
   - 修改演示脚本中的请求参数
   - 测试不同的路线、日期、时间

4. **调试API问题**
   - 如果API有问题，演示脚本会显示详细错误
   - 帮助快速定位问题

## 📝 示例：修改演示参数

如果你想测试不同的路线，可以修改 `predict_delay()` 函数：

```python
# 在 demo.py 中，找到 predict_delay() 函数
# 修改第68-74行的 payload：

payload = {
    "origin": "PAD",      # 改为 Paddington
    "destination": "OXF", # 改为 Oxford
    "departure_date": tomorrow,
    "departure_time": "14:30",  # 改为下午
    "include_fares": True
}
```

## 🔗 相关文件

- **`api/app.py`** - API服务器主文件
- **`api/test_main.py`** - 自动化测试套件
- **`api/USAGE.md`** - API详细使用指南

## 📚 更多信息

运行演示后，可以访问：
- **Swagger UI**: http://localhost:8000/docs
- **ReDoc**: http://localhost:8000/redoc
- **健康检查**: http://localhost:8000/health

